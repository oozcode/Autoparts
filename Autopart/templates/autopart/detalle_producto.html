{% extends 'autopart/base/header.html' %}
{% load static %}
{% load formatos %}
{% load humanize %}
{% block title %}{{ producto.nombre }} - AutoParts{% endblock %}
{% block content %}


<main class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-0">
        <div class="row g-0">
          <div class="col-md-5 text-center bg-light d-flex align-items-center justify-content-center p-4">
            <img src="{{ producto.imagen.url|default:'/static/autopart/img/default.jpg' }}" alt="{{ producto.nombre }}" class="img-fluid rounded" style="max-height: 300px;">
          </div>
          <div class="col-md-7">
            <div class="card-body">
              <h2 class="card-title mb-3">{{ producto.nombre }}</h2>
              <p class="card-text text-muted mb-4">{{ producto.descripcion }}</p>
                {% if es_mayorista %}
                {% if producto.oferta_activa and producto.descuento_oferta %}
                  <span class="badge bg-danger mb-1">{{ producto.descuento_oferta }}% OFF</span>
                  <span class="text-muted text-decoration-line-through">Antes: {{ producto.precio_mayorista|clp }}</span><br>
                  <span class="h5 text-success font-weight-bold">Ahora: {{ producto.precio_oferta_mayorista|clp }}</span>
                {% else %}
                  <span class="h5 text-success font-weight-bold">{{ producto.precio_mayorista|clp }}</span>
                {% endif %}
              {% else %}
                {% if producto.oferta_activa and producto.descuento_oferta %}
                  <span class="badge bg-danger mb-1">{{ producto.descuento_oferta }}% OFF</span>
                  <span class="text-muted text-decoration-line-through">Antes: {{ producto.precio_minorista|clp }}</span><br>
                  <span class="h5 text-success font-weight-bold">Ahora: {{ producto.precio_oferta_minorista|clp }}</span>
                {% else %}
                  <span class="h5 text-success font-weight-bold">{{ producto.precio_minorista|clp }}</span>
                {% endif %}
              {% endif %}

              <div class="mb-3">
                <label for="cantidad" class="form-label">Cantidad</label>
                <input type="number" id="cantidad" value="1" min="1" max="100" class="form-control w-50" />
              </div>
              <button class="btn btn-primary btn-block add-to-cart mb-2"
                data-id="{{ producto.id }}"
                data-name="{{ producto.nombre|escapejs }}"
                data-price="{% if es_mayorista %}
                              {% if producto.oferta_activa and producto.descuento_oferta %}
                                {{ producto.precio_oferta_mayorista }}
                              {% else %}
                                {{ producto.precio_mayorista }}
                              {% endif %}
                            {% else %}
                              {% if producto.oferta_activa and producto.descuento_oferta %}
                                {{ producto.precio_oferta_minorista }}
                              {% else %}
                                {{ producto.precio_minorista }}
                              {% endif %}
                            {% endif %}"
                {% if producto.imagen %}
                  data-image="{{ producto.imagen.url }}"
                {% else %}
                  data-image="{% static 'autopart/img/default.jpg' %}"
                {% endif %}
                data-description="{{ producto.descripcion|escapejs }}"
                data-peso="{{ producto.peso }}"
                data-largo="{{ producto.largo }}"
                data-ancho="{{ producto.ancho }}"
                data-alto="{{ producto.alto }}"
                data-stock="{{ producto.stock }}">
                <i class="fas fa-cart-plus"></i> Agregar al carrito
              </button>
              <div class="mt-4">
                <a href="{% url 'catalogo' %}" class="btn btn-outline-secondary w-100">
                  <i class="fas fa-arrow-left me-2"></i> Volver al catálogo
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 mb-3 shadow-sm border-0">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>Características del producto</h5>
        <div class="row">
          <div class="col-md-6">
            <ul class="list-unstyled mb-0">
              <li><strong>Peso:</strong> {{ producto.peso }} kg</li>
              <li><strong>Largo:</strong> {{ producto.largo }} cm</li>
              <li><strong>Ancho:</strong> {{ producto.ancho }} cm</li>
              <li><strong>Alto:</strong> {{ producto.alto }} cm</li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="list-unstyled mb-0">
              <li><strong>Marca:</strong> {{ producto.marca }}</li>
              <li><strong>Categoría:</strong> {{ producto.categoria }}</li>
              <li><strong>Stock:</strong> {{ producto.stock }}</li>
              <li><strong>Marca de auto:</strong>
                {% for marca in producto.marcas_auto.all %}
                  {{ marca.nombre }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                  <span class="text-muted">Sin marca asociada</span>
                {% endfor %}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</main>
<hr class="my-5">
  <div class="card-header bg-primary text-white fw-bold">
  Comentarios de clientes
  {% if promedio_calificacion %}
    <span class="ms-3">
      <!-- Estrellas visuales -->
      {% for i in "12345"|make_list %}
        {% if i|add:'0' <= promedio_calificacion %}
          <i class="fas fa-star text-warning"></i>
        {% elif i|add:'0' > promedio_calificacion and i|add:'-1' < promedio_calificacion %}
          <i class="fas fa-star-half-alt text-warning"></i>
        {% else %}
          <i class="far fa-star text-warning"></i>
        {% endif %}
      {% endfor %}
      <span class="ms-2">Promedio: {{ promedio_calificacion|floatformat:1 }}/5</span>
    </span>
  {% else %}
    <span class="ms-3 text-light small">(Sin calificaciones aún)</span>
  {% endif %}
</div>
  <div class="card-body">
    {% if user.is_authenticated %}
      <form method="post" class="mb-4">
        {% csrf_token %}
        <div class="mb-2">
          <label class="form-label">Calificación</label>
          <div id="star-rating" class="mb-2">
            {% for i in "12345"|make_list %}
              <i class="fa-star fa-regular star-input" data-value="{{ i }}"></i>
            {% endfor %}
          </div>
          <input type="hidden" name="calificacion" id="id_calificacion" value="5">
        </div>
        <div class="mb-2">
          <label for="id_texto" class="form-label">Comentario</label>
          {{ comentario_form.texto }}
        </div>
        <button type="submit" class="btn btn-success">Enviar comentario</button>
      </form>
    {% else %}
      <p>Debes <a href="{% url 'login' %}">iniciar sesión</a> para dejar un comentario.</p>
    {% endif %}
    {% for comentario in comentarios %}
      <div class="border-bottom pb-2 mb-2">
        <strong>{{ comentario.usuario.username }}</strong>
        <span class="text-warning" style="font-size:1.2em;">
          {% for i in "12345"|make_list %}
            {% if forloop.counter <= comentario.calificacion %}
              <i class="fas fa-star"></i>
            {% else %}
              <i class="far fa-star"></i>
            {% endif %}
          {% endfor %}
        </span>
        <small class="text-muted">{{ comentario.fecha|date:"d M Y H:i" }}</small>
        <p class="mb-0">{{ comentario.texto }}</p>
      </div>
    {% empty %}
      <p class="text-muted">No hay comentarios aún.</p>
    {% endfor %}
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const stars = document.querySelectorAll('#star-rating .star-input');
  const input = document.getElementById('id_calificacion');
  let current = parseInt(input.value);

  function setStars(val) {
    stars.forEach((star, idx) => {
      if (idx < val) {
        star.classList.remove('fa-regular');
        star.classList.add('fa-solid', 'text-warning');
      } else {
        star.classList.remove('fa-solid', 'text-warning');
        star.classList.add('fa-regular');
      }
    });
  }

  setStars(current);

  stars.forEach((star, idx) => {
    star.addEventListener('mouseenter', () => setStars(idx + 1));
    star.addEventListener('mouseleave', () => setStars(current));
    star.addEventListener('click', () => {
      current = idx + 1;
      input.value = current;
      setStars(current);
    });
  });
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Formato CLP para el precio
    const precio = document.getElementById("precioProducto");
    if (precio) {
      let num = Number(precio.textContent.replace(/[^0-9.-]+/g,""));
      precio.textContent = num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
    }

 // Agregar al carrito y mostrar toast, validando stock

document.querySelectorAll('.add-to-cart').forEach(button => {
  button.addEventListener('click', () => {
    const stock = parseInt(button.dataset.stock, 10);
    // 1. Leemos la cantidad del input
    const cantidadInput = document.getElementById('cantidad');
    let quantity = parseInt(cantidadInput.value, 10) || 1;
    quantity = Math.max(1, Math.min(quantity, stock));

    // 2. Construimos el producto
    const product = {
      id:           parseInt(button.dataset.id, 10),
      name:         button.dataset.name,
      price:        parseInt(button.dataset.price, 10),
      image:        button.dataset.image,
      description:  button.dataset.description,
      peso:         parseFloat(button.dataset.peso),
      largo:        parseFloat(button.dataset.largo),
      ancho:        parseFloat(button.dataset.ancho),
      alto:         parseFloat(button.dataset.alto),
      stock:        stock,
      quantity:     quantity
    };

    // 3. Actualizamos el cart en localStorage
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const existing = cart.find(p => p.id === product.id);
    const inCartQty = existing ? existing.quantity : 0;
    if (existing) {
      if (existing.quantity + quantity <= stock) {
        existing.quantity += quantity;
      } else {
        // notificación de stock insuficiente
        return Swal.fire({
          title: '⚠️ ¡Stock insuficiente!',
          html: `
            <p>Solo quedan <strong>${stock}</strong> unidad(es) disponibles.</p>
              <p>Actualmente tienes <strong>${inCartQty}</strong> unidad(es) de <em>${product.name}</em> en tu carrito.</p>
              <p><img src="${product.image}" alt="${product.name}" style="width:80px; margin:10px auto; display:block; border-radius:5px;"></p>
            `,
            icon: 'warning',
            confirmButtonText: 'Aceptar',
            buttonsStyling: false,
            customClass: { confirmButton: 'btn btn-primary' },
            width: '400px',
            background: '#f8f9fa'
          }).then((result) => {
        if (result.isConfirmed) {
          // Redirige a catálogo

        } else if (result.dismiss === Swal.DismissReason.cancel) {
          // Aquí podrías abrir un modal para que el cliente deje su e-mail
          // o invocar tu propia función de “notificar cuando reponga stock”.
          console.log('Cliente quiere notificación de reposición.');
        }
      });
      }
    } else {
      if (stock > 0) {
        cart.push(product);
      } else {
        const inCart = existing ? existing.quantity : 0;
          return Swal.fire({
            title: '😞 ¡Producto agotado!',
            html: `
              <p><strong>${product.name}</strong> no está disponible.</p>
              <p>Actualmente tienes <strong>${inCart}</strong> unidad(es) de este producto en tu carrito.</p>
              <p>¿Quieres que te notifiquemos cuando repongamos stock?</p>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Volver al catálogo',
            cancelButtonText: 'Notificarme',
            buttonsStyling: false,
            customClass: {
              popup: 'swal2-popup-autoparts',
              title: 'swal2-title-autoparts',
              htmlContainer: 'swal2-html-autoparts',
              confirmButton: 'btn btn-outline-secondary mx-1',
              cancelButton: 'btn btn-primary mx-1'
            },
            width: '400px',
            background: '#f8f9fa',
            backdrop: `
              rgba(0,0,0,0.4)
              url("/static/autopart/img/sad-car.gif")
              center top
              no-repeat
            `
          }).then(result => {
            if (result.isConfirmed) {
              window.location.href = "{% url 'catalogo' %}";
            }
          });
      }
    }

    localStorage.setItem('cart', JSON.stringify(cart));

    // 4. Ahora sí, notificamos siempre
    const inCart = cart.find(p => p.id === product.id).quantity;
    Swal.fire({
      title: '🛒 ¡Producto agregado!',
      html: `
        <p>Has agregado <strong>${quantity}</strong> unidad(es) de:</p>
        <p><em>${product.name}</em></p>
        <img src="${product.image}" alt="${product.name}"
             style="width:80px; margin:10px auto; display:block; border-radius:5px;">
        <p>Ahora tienes <strong>${inCart}</strong> en tu carrito.</p>
      `,
      icon: 'success',
      showCancelButton: true,
      confirmButtonText: 'Ver carrito',
      cancelButtonText: 'Seguir comprando',
      customClass: {
        confirmButton: 'btn btn-primary mx-1',
        cancelButton:  'btn btn-outline-secondary mx-1'
      },
      buttonsStyling: false,
      width: '400px',
      background: '#f8f9fa'
    }).then(result => {
      if (result.isConfirmed) {
        window.location.href = "{% url 'carrito' %}";
      }
    });

  });
});
  });
</script>
</script>
{% include 'autopart/base/footer.html' %}
{% endblock %}

