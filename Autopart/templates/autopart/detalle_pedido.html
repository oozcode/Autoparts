{% extends 'autopart/base/header.html' %}
{% block title %}Detalle del Pedido #{{ pedido.id }}{% endblock %}
{% load custom_filters %}
{% block content %}
<div class="container my-5">
  <h2>Detalle del Pedido #{{ pedido.id }}</h2>
  <div class="card mb-4">
    <div class="card-body">
      <p><strong>Fecha:</strong> {{ pedido.created_at|date:"d/m/Y H:i" }}</p>
      <p><strong>Estado:</strong> {{ pedido.estado }}</p>
      <p><strong>Tipo de Pedido:</strong> {{ pedido.tipo_pedido }}</p>
      <p><strong>Dirección:</strong> {{ pedido.calle }} {{ pedido.numero }} {{ pedido.complemento }}, {{ pedido.comuna }}, {{ pedido.region }}</p>
    </div>
  </div>
  <div class="card">
    <div class="card-header bg-secondary text-white">Productos</div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Imagen</th>
            <th>Producto</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Precio Unitario</th>
            <th class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for producto in productos %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              {% if producto.producto.imagen %}
                <img src="{{ producto.producto.imagen.url }}" alt="{{ producto.producto.nombre }}" style="width:60px; height:auto;">
              {% else %}
                <span>Sin imagen</span>
              {% endif %}
            </td>
            <td>{{ producto.producto.nombre }}</td>
            <td class="text-end">{{ producto.quantity }}</td>
            <td class="text-end clp">${{ producto.price|floatformat:0 }}</td>
            <td class="text-end clp">${{ producto.price|mul:producto.quantity|floatformat:0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <hr>
      <p><strong>Subtotal:</strong> <span class="clp">{{ pedido.subtotal|floatformat:0 }}</span></p>
      <p><strong>IVA (19%):</strong> <span class="clp">{{ pedido.iva|floatformat:0 }}</span></p>
      <p><strong>Envío:</strong> <span class="clp">{{ pedido.envio|floatformat:0 }}</span></p>
      <h4><strong>Total:</strong> <span class="clp">{{ pedido.total|floatformat:0 }}</span></h4>
    </div>
  </div>
  <a href="{% url 'mis_pedidos' %}" class="btn btn-secondary mt-3">Volver a mis pedidos</a>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.clp').forEach(function(el) {
    let num = Number(el.textContent.replace(/[^0-9.-]+/g,""));
    el.textContent = num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
  });
});
</script>
{% include 'autopart/base/footer.html' %}
{% endblock %}
