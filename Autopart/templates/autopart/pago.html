{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pago</title>
  <link rel="stylesheet" href="{% static 'autopart/css/estilos.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-pb3PH0+nsdQ5xipFqjB3Lk6t7aXfDqN7L+4I4Y8U7Jj3VL4AN+VTXhRXN4dO3rF64rGiH0LsM3ij+J5bEyIcjA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>

<body>
  <nav class="navbar">
        <a href="{% url 'index' %}" class="navbar-brand">
            <img src="{% static 'autopart/img/Icono.png' %}" alt="AutoParts Logo" class="logo">
        </a>
        <div class="nav-links">
            <a href="{% url 'catalogo' %}">Catálogo</a>
            <a href="{% url 'carrito' %}">Carrito de compras</a>
            {% if request.user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user-circle fa-2x"></i> 
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="">Perfil</a>
                            <a class="dropdown-item" href="">Cerrar Sesión</a>
                        </div>
                    </li>
            {% else %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user-circle fa-2x"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="{% url 'login' %}">Ingresar</a>
                            <a class="dropdown-item" href="{% url 'registro' %}">Registrarse</a>
                        </div>
                    </li>
            {% endif %}

        </div>
    </nav>

  <main class="container my-5">
    <div class="row g-4">
      <!-- Formulario de facturación -->
      <section class="col-md-7 form-section p-4 shadow rounded bg-white animate-fade-in">
        <h4 class="mb-4">Detalles de facturación</h4>
        <form id="billingForm" novalidate>
          <div class="mb-3">
            <label for="rut" class="form-label">RUT</label>
            <input type="text" class="form-control" id="rut" placeholder="12345678-9" required />
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombre" required />
            </div>
            <div class="col-md-6">
              <label for="apellidos" class="form-label">Apellidos</label>
              <input type="text" class="form-control" id="apellidos" required />
            </div>
          </div>

          <div class="mb-3">
            <label for="region" class="form-label">Región</label>
            <select id="region" class="form-select" required>
              <option value="">Seleccione una región</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="comuna" class="form-label">Comuna</label>
            <select id="comuna" class="form-select" required>
              <option value="">Seleccione una comuna</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="calle" class="form-label">Nombre de la Calle</label>
            <input type="text" class="form-control" id="calle" required />
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="numero" class="form-label">Número</label>
              <input type="text" class="form-control" id="numero" />
            </div>
            <div class="col-md-6">
              <label for="complemento" class="form-label">Complemento (opcional)</label>
              <input type="text" class="form-control" id="complemento" />
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="email" class="form-label">Correo electrónico</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="col-md-6">
              <label for="telefono" class="form-label">Teléfono</label>
              <input type="tel" class="form-control" id="telefono" required />
            </div>
          </div>
          <div class="mt-3">
            <label for="tipo_pedido" class="form-label">Tipo de Pedido</label>
            <select id="tipo_pedido" class="form-select" required>
              <option value="">Selecciona una opción</option>
              <option value="delivery">Delivery</option>
              <option value="retiro">Retiro en tienda</option>
            </select>
          </div>

          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" id="btnSiguiente" class="btn btn-primary" disabled>
              Siguiente
              <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </form>
      </section>

      <!-- Resumen del pedido -->
      <section
        class="col-md-5 order-summary p-4 shadow rounded bg-white animate-fade-in delay-1"
      >
        <h4 class="mb-4">Tu pedido</h4>
        <div id="cartItems" class="mb-4">
          <!-- Productos se insertan aquí con JS -->
        </div>

        <div class="d-flex justify-content-between mb-2 summary-line">
          <span>Subtotal</span>
          <span id="subtotal"></span>
        </div>

      <!-- Envío -->
      <div class="row mb-3" id="envioContainer">
        <div class="col-4"><strong>Envío</strong></div>
        <div class="col-8" id="shippingOptions">
           
          <!-- Opciones de envío se insertarán aquí -->
        </div>
        <button id="calcularEnvio" style="display: none;">Calcular Envío</button>

      </div>
     


        <div class="d-flex justify-content-between mt-3 summary-total">
          <span class="fw-bold">Total</span>
          <span class="fw-bold" id="totalFinal"></span>
        </div>
        <div class="text-muted small mt-1">
          Incluye <span id="impuestos"></span> de impuestos
        </div>
      </section>
    </div>
  </main>

  <script src="{% static 'autopart/js/regiones_comunas_api.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const cartItemsContainer = document.getElementById("cartItems");
  const subtotalEl = document.getElementById("subtotal");
  const impuestosEl = document.getElementById("impuestos");
  const totalFinalEl = document.getElementById("totalFinal");

  let subtotal = 0;

  if (cart.length === 0) {
    cartItemsContainer.innerHTML = "<p class='text-muted'>Tu carrito está vacío.</p>";
    subtotalEl.textContent = "$0";
    impuestosEl.textContent = "$0";
    totalFinalEl.textContent = "$0";
    return;
  }

  cart.forEach(item => {
    const totalItem = item.price * item.quantity;
    subtotal += totalItem;

    const itemHTML = `
      <div class="d-flex justify-content-between border-bottom py-2">
        <div>
          <strong>${item.name}</strong>
          <div class="text-muted small">Cantidad: ${item.quantity}</div>
        </div>
        <div>
          ${totalItem.toLocaleString("es-CL", { style: "currency", currency: "CLP" })}
        </div>
      </div>
    `;
    cartItemsContainer.insertAdjacentHTML("beforeend", itemHTML);
  });

  const iva = subtotal * 0.19;
  const total = subtotal + iva;

  subtotalEl.textContent = subtotal.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
  impuestosEl.textContent = iva.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
  totalFinalEl.textContent = total.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
});
</script>

</body>
</html>
{% include 'autopart/base/footer.html' %}