{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pago</title>
  <link rel="stylesheet" href="{% static 'autopart/css/estilos.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  {% include 'autopart/base/header.html' %}

  <main class="container my-5">
    <div class="row g-4">
      <!-- Formulario de facturación -->
      <section class="col-md-7 form-section p-4 shadow rounded bg-white animate-fade-in">
        <h4 class="mb-4">Detalles de facturación</h4>
        <form id="billingForm" novalidate>
          <div class="mb-3">
            <label for="rut" class="form-label">RUT</label>
            <input type="text" class="form-control" id="rut" placeholder="12345678-9" required pattern="^\d{7,8}-[\dkK]{1}$" title="Ejemplo: 12345678-9" />
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombre" required />
            </div>
            <div class="col-md-6">
              <label for="apellidos" class="form-label">Apellidos</label>
              <input type="text" class="form-control" id="apellidos" required />
            </div>
          </div>

          <div class="mb-3">
            <label for="region" class="form-label">Región</label>
            <select id="region" class="form-select" required>
              <option value="">Seleccione una región</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="comuna" class="form-label">Comuna</label>
            <select id="comuna" class="form-select" required>
              <option value="">Seleccione una comuna</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="calle" class="form-label">Nombre de la Calle</label>
                          <input type="text" class="form-control" id="calle" />

          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="numero" class="form-label">Número</label>
            <input type="text" class="form-control" id="numero" pattern="^\d+$" title="Solo números" />
            </div>
            <div class="col-md-6">
              <label for="complemento" class="form-label">Complemento (opcional)</label>
              <input type="text" class="form-control" id="complemento" />
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="email" class="form-label">Correo electrónico</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="col-md-6">
              <label for="telefono" class="form-label">Teléfono</label>
              <input type="tel" class="form-control"  placeholder="987654321"  id="telefono" required pattern="^\d{9}$" title="Solo números, 9 dígitos" />
            </div>
          </div>
          <div class="mt-3">
            <label for="tipo_pedido" class="form-label">Tipo de Pedido</label>
            <select id="tipo_pedido" class="form-select" required>
              <option value="">Selecciona una opción</option>
              <option value="delivery">Delivery</option>
              <option value="retiro">Retiro en tienda</option>
            </select>
          </div>

          

          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" id="btnSiguiente" class="btn btn-primary" disabled>
              Siguiente
              <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </form>
      </section>

      <!-- Resumen del pedido -->
      <!-- ...dentro del resumen del pedido... -->
      <section class="col-md-5 order-summary p-4 shadow rounded bg-white animate-fade-in delay-1">
        <h4 class="mb-4">Tu pedido</h4>
        <div id="cartItems" class="mb-4"></div>

        <div class="d-flex justify-content-between mb-2 summary-line">
          <span>Subtotal</span>
          <span id="subtotal"></span>
        </div>

        <!-- NUEVO: Línea para mostrar el IVA -->
        <div class="d-flex justify-content-between mb-2 summary-line">
          <span>IVA (19%)</span>
          <span id="impuestos"></span>
        </div>

        <div class="row mb-3" id="envioContainer" style="display: none;">
          <div class="col-4"><strong>Envío</strong></div>
          <div class="col-8" id="shippingOptions"></div>
          <button id="calcularEnvio" style="display: none;">Calcular Envío</button>
        </div>

        <div class="d-flex justify-content-between mb-2">
          <span>Envío</span>
          <span id="envio">0</span>
        </div>

        <div class="d-flex justify-content-between mt-3 summary-total">
          <span class="fw-bold">Total</span>
          <span class="fw-bold" id="totalFinal"></span>
        </div>
        <div class="text-muted small mt-1">
          Incluye <span id="impuestos"></span> de impuestos
        </div>
      </section>
    </div>
  </main>

  <script src="{% static 'autopart/js/envio_chilexpress.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("billingForm");
  const btnSiguiente = document.getElementById("btnSiguiente");
  const tipoPedido = document.getElementById("tipo_pedido");
  const envio = document.getElementById("envio");

  function validarEnvio() {
    const isFormValid = form.checkValidity();
    const isDelivery = tipoPedido.value === "delivery";
    // Considera envío como número (puede venir como "$0" o "0")
    const envioValor = parseInt(envio.textContent.replace(/[^\d]/g, "")) || 0;

    if (isDelivery && envioValor === 0) {
      btnSiguiente.disabled = true;
    } else {
      btnSiguiente.disabled = !isFormValid;
    }
  }

  form.addEventListener("input", validarEnvio);
  tipoPedido.addEventListener("change", validarEnvio);

  // Si el valor de envío puede cambiar dinámicamente, observa cambios:
  const observer = new MutationObserver(validarEnvio);
  observer.observe(envio, { childList: true, subtree: true });

  form.addEventListener("submit", e => {
    e.preventDefault();

    const cliente = {
      rut: document.getElementById("rut").value,
      nombre: document.getElementById("nombre").value,
      apellidos: document.getElementById("apellidos").value,
      region: document.getElementById("region").selectedOptions[0]?.textContent || "",
      comuna: document.getElementById("comuna").selectedOptions[0]?.textContent || "",
      calle: document.getElementById("calle").value,
      numero: document.getElementById("numero").value,
      complemento: document.getElementById("complemento").value,
      email: document.getElementById("email").value,
      telefono: document.getElementById("telefono").value,
      tipo_pedido: document.getElementById("tipo_pedido").value
    };

    localStorage.setItem("cliente", JSON.stringify(cliente));

    // Calculamos y guardamos valores si corresponde
    const subtotalTexto = document.getElementById("subtotal")?.textContent || "$0";
    const envioTexto = document.getElementById("envio")?.textContent || "$0";
    const impuestosTexto = document.getElementById("impuestos")?.textContent || "$0";
    const totalTexto = document.getElementById("totalFinal")?.textContent || "$0";

    const resumen = {
      subtotal: parseInt(subtotalTexto.replace(/[^\d]/g, "")) || 0,
      envio: parseInt(envioTexto.replace(/[^\d]/g, "")) || 0,
      iva: parseInt(impuestosTexto.replace(/[^\d]/g, "")) || 0,
      total: parseInt(totalTexto.replace(/[^\d]/g, "")) || 0
    };

    localStorage.setItem("resumen", JSON.stringify(resumen));
    console.log(resumen)
    window.location.href = "/resumen_pedido/";
  });

  // Llama una vez al cargar para el estado inicial
  validarEnvio();
});
</script>
  {% include 'autopart/base/footer.html' %}
</body>
</html>
