{% extends 'autopart/base/header.html' %}
{% block content %}
<main>
  <div style="height: 100px;"></div>
  <div class="container mt-5 pt-4">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-9">
        <div class="bg-white rounded shadow p-4">
          <h2 class="mb-4 text-center">ðŸ‘¥ Lista de Usuarios</h2>

          <form method="get" class="form-inline justify-content-center mb-4">
            <input type="text" name="q" placeholder="Buscar por nombre o correo" value="{{ query|default_if_none:'' }}" class="form-control mr-2 w-50">
            <select name="tipo" class="form-control mr-2">
              <option value="">Todos</option>
              <option value="mayorista" {% if tipo == 'mayorista' %}selected{% endif %}>Mayorista</option>
              <option value="minorista" {% if tipo == 'minorista' %}selected{% endif %}>Minorista</option>
              <option value="vendedor" {% if tipo == 'vendedor' %}selected{% endif %}>Vendedor</option>
              <option value="staff" {% if tipo == 'staff' %}selected{% endif %}>Staff</option>
            </select>
            <button type="submit" class="btn btn-primary">Filtrar</button>
          </form>

          <div class="table-responsive">
            <table class="table table-striped table-hover text-center align-middle">
              <thead class="thead-dark">
                <tr>
                  <th>ID</th>
                  <th>Nombre Completo</th>
                  <th>Email</th>
                  <th>Tipo Cliente</th>
                  <th>Vendedor</th>
                  <th>Staff</th>
                  <th>Mayorista</th>
                </tr>
              </thead>
              <tbody>
                {% for user in usuarios %}
                <tr>
                  <td>{{ user.id }}</td>
                  <td>{{ user.get_full_name }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    {% if user.perfilusuario.tipo_cliente %}
                      <span class="badge badge-info">{{ user.perfilusuario.tipo_cliente.nombre }}</span>
                    {% else %}
                      <span class="badge badge-secondary">Sin asignar</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.es_vendedor %}
                      <button onclick="confirmarQuitarVendedor({{ user.id }})" class="btn btn-sm btn-outline-danger">Quitar</button>
                    {% else %}
                      <button onclick="confirmarAsignarVendedor({{ user.id }})" class="btn btn-sm btn-outline-success">Asignar</button>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.is_staff %}
                      <span class="text-primary fw-bold">âœ” Staff</span>
                    {% else %}
                      <span class="text-muted">No</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.es_mayorista %}
                      <button onclick="confirmarQuitarMayorista({{ user.id }})" class="btn btn-sm btn-outline-danger">Quitar</button>
                    {% else %}
                      <button onclick="confirmarAsignarMayorista({{ user.id }})" class="btn btn-sm btn-outline-primary">Asignar</button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- CSRF para uso global -->
<script>
  function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfInput ? csrfInput.value : '{{ csrf_token }}';
  }

  function confirmarAccion(url, titulo, texto, icono) {
    Swal.fire({
      title: titulo,
      text: texto,
      icon: icono,
      showCancelButton: true,
      confirmButtonText: 'SÃ­, confirmar',
      cancelButtonText: 'Cancelar'
    }).then(result => {
      if (result.isConfirmed) {
        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          }
        }).then(response => {
          if (response.ok) {
            location.reload();
          } else {
            Swal.fire('Error', 'Hubo un problema al procesar la solicitud.', 'error');
          }
        });
      }
    });
  }

  function confirmarAsignarVendedor(userId) {
    confirmarAccion(`/asignar-vendedor/${userId}/`, 'Â¿Asignar como vendedor?', 'Esta acciÃ³n asignarÃ¡ al usuario al grupo vendedor.', 'question');
  }

  function confirmarQuitarVendedor(userId) {
    confirmarAccion(`/quitar-vendedor/${userId}/`, 'Â¿Quitar rol de vendedor?', 'El usuario ya no serÃ¡ vendedor.', 'warning');
  }

  function confirmarAsignarMayorista(userId) {
    confirmarAccion(`/asignar-mayorista/${userId}/`, 'Â¿Asignar como mayorista?', 'Esta acciÃ³n asignarÃ¡ al usuario el tipo Mayorista.', 'question');
  }

  function confirmarQuitarMayorista(userId) {
    confirmarAccion(`/quitar-mayorista/${userId}/`, 'Â¿Quitar rol de mayorista?', 'El usuario volverÃ¡ a ser minorista.', 'warning');
  }
</script>

{% include 'autopart/base/footer.html' %}
{% endblock %}